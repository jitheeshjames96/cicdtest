name: Build Multi-Arch Node App

on:
  workflow_dispatch:

env:
  APP_NAME: sample-app
  APP_DIR: sample-app
  S3_BUCKET: ${{ secrets.S3_BUCKET }}

jobs:

  build:

    strategy:
      matrix:
        arch: [amd64, arm64]

    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:

      # checkout repo
      - name: Checkout code
        uses: actions/checkout@v4

      # debug folder structure (safe to keep)
      - name: Show repo structure
        run: ls -R

      # setup node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # configure AWS OIDC
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      # install dependencies per architecture
      - name: Install dependencies
        working-directory: ${{ env.APP_DIR }}
        run: |
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            npm install --arch=arm64
          else
            npm install --arch=x64
          fi

      # create build metadata
      - name: Generate build metadata
        working-directory: ${{ env.APP_DIR }}
        run: |
          VERSION=v$(date +%Y%m%d%H%M)
          echo "VERSION=$VERSION" > build-info.txt
          echo "ARCH=${{ matrix.arch }}" >> build-info.txt
          echo "BUILT_BY=github-actions" >> build-info.txt
          echo "BUILD_TIME=$(date)" >> build-info.txt

      # package artifact
      - name: Package artifact
        run: |
          VERSION=v$(date +%Y%m%d%H%M)

          mkdir build-${{ matrix.arch }}
          cp -r $APP_DIR/* build-${{ matrix.arch }}

          zip -r ${{ matrix.arch }}.zip build-${{ matrix.arch }}

      # upload artifacts to S3
      - name: Upload artifact to S3
        run: |
          VERSION=v$(date +%Y%m%d%H%M)

          aws s3 cp ${{ matrix.arch }}.zip \
          s3://$S3_BUCKET/$APP_NAME/$VERSION/${{ matrix.arch }}.zip

          aws s3 cp ${{ matrix.arch }}.zip \
          s3://$S3_BUCKET/$APP_NAME/latest/${{ matrix.arch }}.zip

      # trigger Jenkins deployment
      - name: Trigger Jenkins
        run: |
          VERSION=v$(date +%Y%m%d%H%M)

          curl -X POST ${{ secrets.JENKINS_URL }} \
          --user ${{ secrets.JENKINS_USER }}:${{ secrets.JENKINS_TOKEN }} \
          --data version=$VERSION
